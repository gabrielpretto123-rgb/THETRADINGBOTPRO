<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 TradingBot Pro - Reddito Passivo Automatico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        
        .hero-section {
            text-align: center; padding: 40px 20px;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
        }
        
        .hero-section h1 {
            font-size: 2.5rem; margin-bottom: 20px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,215,0,0.3);
        }
        
        .hero-section p { font-size: 1.2rem; opacity: 0.9; margin-bottom: 30px; }
        
        .container { 
            max-width: 1200px; margin: 0 auto; padding: 20px;
            background: rgba(255,255,255,0.95); border-radius: 20px;
            color: #333; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .login-section {
            text-align: center; padding: 40px 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px; margin: 20px 0;
        }
        
        .login-form { max-width: 400px; margin: 0 auto; }
        .login-form input, .login-form button { 
            width: 100%; margin: 10px 0; padding: 15px; border-radius: 10px;
            border: 2px solid #ddd; font-size: 1rem;
        }
        
        .login-form button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; cursor: pointer; font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .login-form button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        
        .dashboard { display: none; }
        
        .section-card {
            background: white; border-radius: 15px; padding: 25px; margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 5px solid #667eea;
        }
        
        .section-title {
            font-size: 1.4rem; font-weight: bold; margin-bottom: 20px;
            color: #2c3e50; display: flex; align-items: center; gap: 10px;
        }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { 
            display: block; font-weight: bold; margin-bottom: 8px; 
            color: #2c3e50; font-size: 0.95rem;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 1rem; transition: border-color 0.3s ease;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .mode-selector {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;
        }
        
        .mode-card {
            padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; border: 3px solid transparent;
        }
        
        .mode-paper { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .mode-live { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        
        .mode-card.selected { 
            border-color: #FFD700; transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .strategy-selector {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
        }
        
        .strategy-card {
            padding: 15px; border-radius: 10px; background: #f8f9fa; cursor: pointer;
            border: 2px solid #e9ecef; transition: all 0.3s ease;
        }
        
        .strategy-card:hover, .strategy-card.selected {
            border-color: #667eea; background: #667eea; color: white;
        }
        
        .risk-controls {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
            padding: 20px; background: #f8f9fa; border-radius: 10px;
        }
        
        .symbols-input {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
        }
        
        .symbol-tag {
            background: #667eea; color: white; padding: 5px 10px; border-radius: 15px;
            font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
        }
        
        .symbol-tag .remove { cursor: pointer; font-weight: bold; }
        
        .status-panel {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white; padding: 20px; border-radius: 10px; text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .status-value { font-size: 1.8rem; font-weight: bold; margin-bottom: 5px; }
        .status-label { font-size: 0.9rem; color: #666; }
        
        .profit { color: #27ae60; }
        .loss { color: #e74c3c; }
        
        .control-buttons {
            display: flex; gap: 15px; justify-content: center; margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px; border-radius: 10px; border: none; font-size: 1rem;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .btn-start { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-save { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .activity-log {
            background: #2c3e50; color: white; border-radius: 10px; padding: 20px;
            max-height: 400px; overflow-y: auto; margin: 20px 0;
        }
        
        .log-entry {
            padding: 8px 0; border-bottom: 1px solid #34495e; display: flex;
            justify-content: space-between; align-items: center; font-size: 0.9rem;
        }
        
        .log-entry:last-child { border-bottom: none; }
        
        .feature-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;
        }
        
        .feature-icon { font-size: 2.5rem; margin-bottom: 15px; }
        
        /* Nuovi stili per la dashboard avanzata */
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .trades-table th, .trades-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .trades-table th {
            background-color: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .trades-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .trades-table tr:hover {
            background-color: #e9ecef;
        }
        
        .profit-cell {
            color: #27ae60;
            font-weight: bold;
        }
        
        .loss-cell {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            font-weight: bold;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .hero-section h1 { font-size: 2rem; }
            .mode-selector { grid-template-columns: 1fr; }
            .control-buttons { flex-direction: column; align-items: center; }
            .btn { min-width: 200px; }
            .trades-table { display: block; overflow-x: auto; }
        }
        
        .premium-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;
            font-weight: bold; margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="hero-section">
        <h1>🚀 TradingBot Pro 2.0</h1>
        <p>Il Tuo Sistema di Reddito Passivo Automatico Avanzato</p>
        <p><strong>Sicuro • Personalizzabile • Professionale</strong></p>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="container">
        <div class="login-section">
            <h2>🔐 Accesso Sicuro</h2>
            <p>Ogni utente ha il proprio account personale e sicuro</p>
            <div class="login-form">
                <input type="email" id="email" placeholder="La tua email" required>
                <input type="password" id="password" placeholder="Password sicura" required>
                <button onclick="handleLogin()">🚀 ACCEDI</button>
                <button onclick="handleRegister()" style="background: linear-gradient(135deg, #f39c12, #e67e22); margin-top: 10px;">📝 REGISTRATI</button>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">🛡️</div>
                <h3>Sicurezza Avanzata</h3>
                <p>I tuoi dati sono crittografati e protetti. Ogni utente ha il proprio spazio privato.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📱</div>
                <h3>Mobile Friendly</h3>
                <p>Configura e monitora il tuo bot da qualsiasi dispositivo, ovunque tu sia.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">⚙️</div>
                <h3>Completamente Personalizzabile</h3>
                <p>Strategie, stop loss, take profit, simboli - tutto configurabile secondo le tue preferenze.</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">💰</div>
                <h3>Reddito Passivo</h3>
                <p>Il bot opera 24/7 per generare profitti automaticamente mentre tu fai altro.</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="container dashboard">
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('dashboard')">📊 Dashboard</div>
            <div class="tab" onclick="switchTab('configuration')">⚙️ Configurazione</div>
            <div class="tab" onclick="switchTab('history')">📜 Storico</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- Statistics -->
            <div class="section-card">
                <h2 class="section-title">📊 Statistiche Performance</h2>
                <div class="status-panel">
                    <div class="status-card">
                        <div id="totalTrades" class="status-value">0</div>
                        <div class="status-label">Trade Totali</div>
                    </div>
                    <div class="status-card">
                        <div id="winRate" class="status-value">0%</div>
                        <div class="status-label">Win Rate</div>
                    </div>
                    <div class="status-card">
                        <div id="totalPL" class="status-value profit">$0.00</div>
                        <div class="status-label">P&L Totale</div>
                    </div>
                    <div class="status-card">
                        <div id="dailyPL" class="status-value">$0.00</div>
                        <div class="status-label">P&L Oggi</div>
                    </div>
                    <div class="status-card">
                        <div id="monthlyPL" class="status-value">$0.00</div>
                        <div class="status-label">P&L Mensile</div>
                    </div>
                    <div class="status-card">
                        <div id="botStatus" class="status-value" style="color: #e67e22;">FERMO</div>
                        <div class="status-label">Status</div>
                    </div>
                </div>
            </div>

            <!-- Performance Chart -->
            <div class="section-card">
                <h2 class="section-title">📈 Andamento Performance</h2>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="section-card">
                <h2 class="section-title">🎮 Controlli Bot</h2>
                <div class="control-buttons">
                    <button id="startBtn" class="btn btn-start" onclick="toggleBot()">🚀 AVVIA BOT</button>
                    <button class="btn btn-save" onclick="saveConfiguration()">💾 SALVA CONFIG</button>
                    <button class="btn btn-stop" onclick="emergencyStop()">🚨 STOP EMERGENZA</button>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="section-card">
                <h2 class="section-title">📝 Log Attività</h2>
                <div class="activity-log" id="activityLog">
                    <div class="log-entry">
                        <span>Sistema inizializzato e pronto</span>
                        <span>🟢</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="configurationTab" class="tab-content">
            <!-- Mode Selection -->
            <div class="section-card">
                <h2 class="section-title">🎯 Modalità Operativa</h2>
                <div class="mode-selector">
                    <div class="mode-card mode-paper" onclick="selectMode('paper')">
                        <h3>📝 Paper Trading</h3>
                        <p><strong>SICURO</strong><br>Soldi virtuali per testare le strategie</p>
                    </div>
                    <div class="mode-card mode-live" onclick="selectMode('live')">
                        <h3>🔴 Trading Reale</h3>
                        <p><strong>ATTENZIONE</strong><br>Operazioni con denaro reale</p>
                        <span class="premium-badge">PRO</span>
                    </div>
                </div>
            </div>

            <!-- API Configuration -->
            <div class="section-card">
                <h2 class="section-title">🔑 Configurazione API</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label>🏦 Alpaca API Key</label>
                        <input type="password" id="apiKey" placeholder="La tua API Key Alpaca">
                        <small>Ottieni le credenziali da <a href="https://alpaca.markets" target="_blank">alpaca.markets</a></small>
                    </div>
                    <div class="input-group">
                        <label>🔒 Alpaca Secret Key</label>
                        <input type="password" id="secretKey" placeholder="La tua Secret Key">
                    </div>
                    <div class="input-group">
                        <label>📱 Telegram Bot Token</label>
                        <input type="text" id="telegramToken" placeholder="Token del tuo bot Telegram">
                        <small>Crea un bot con <a href="https://t.me/botfather" target="_blank">@BotFather</a></small>
                    </div>
                    <div class="input-group">
                        <label>💬 Chat ID Telegram</label>
                        <input type="text" id="chatId" placeholder="Il tuo Chat ID">
                        <button type="button" onclick="testTelegram()" class="btn" style="margin-top: 10px; min-width: auto; padding: 8px 15px;">🧪 Test</button>
                    </div>
                </div>
            </div>

            <!-- Strategy Selection -->
            <div class="section-card">
                <h2 class="section-title">📊 Strategia di Trading</h2>
                <div class="strategy-selector">
                    <div class="strategy-card" onclick="selectStrategy('sma_crossover')">
                        <h4>📈 SMA Crossover</h4>
                        <p>Medie mobili incrociate</p>
                    </div>
                    <div class="strategy-card" onclick="selectStrategy('rsi_oversold')">
                        <h4>⚡ RSI Oversold</h4>
                        <p>Ipervenduto/ipercomprato</p>
                    </div>
                    <div class="strategy-card" onclick="selectStrategy('momentum')">
                        <h4>🚀 Momentum</h4>
                        <p>Segue il trend</p>
                    </div>
                    <div class="strategy-card" onclick="selectStrategy('mean_reversion')">
                        <h4>🔄 Mean Reversion</h4>
                        <p>Ritorno alla media</p>
                    </div>
                    <div class="strategy-card" onclick="selectStrategy('super_trend')">
                        <h4>📊 Super Trend</h4>
                        <p>Nuova strategia avanzata</p>
                        <span class="premium-badge">NUOVO</span>
                    </div>
                    <div class="strategy-card" onclick="selectStrategy('macd_crossover')">
                        <h4>📉 MACD Crossover</h4>
                        <p>Analisi MACD avanzata</p>
                        <span class="premium-badge">NUOVO</span>
                    </div>
                </div>
            </div>

            <!-- Risk Management -->
            <div class="section-card">
                <h2 class="section-title">🛡️ Gestione del Rischio</h2>
                <div class="risk-controls">
                    <div class="input-group">
                        <label>💰 Budget per Trade ($)</label>
                        <input type="number" id="tradeAmount" value="100" min="10" max="10000">
                    </div>
                    <div class="input-group">
                        <label>🛑 Stop Loss (%)</label>
                        <input type="number" id="stopLoss" value="2" min="0.5" max="10" step="0.1">
                        <small>Lo stop loss dinamico può modificare questo valore</small>
                    </div>
                    <div class="input-group">
                        <label>🎯 Take Profit (%)</label>
                        <input type="number" id="takeProfit" value="4" min="1" max="20" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>📊 Max Trade Giornalieri</label>
                        <input type="number" id="maxTrades" value="10" min="1" max="100">
                    </div>
                </div>
            </div>

            <!-- Symbol Selection -->
            <div class="section-card">
                <h2 class="section-title">📈 Selezione Titoli</h2>
                <div class="input-group">
                    <label>🎯 Aggiungi Simbolo</label>
                    <input type="text" id="newSymbol" placeholder="es. AAPL, TSLA, NVDA" onkeypress="addSymbolOnEnter(event)">
                    <button type="button" onclick="addSymbol()" class="btn" style="margin-top: 10px; min-width: auto; padding: 8px 15px;">➕ Aggiungi</button>
                </div>
                <div id="symbolsList" class="symbols-input">
                    <!-- Symbols will be added here dynamically -->
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content">
            <div class="section-card">
                <h2 class="section-title">📜 Storico Operazioni</h2>
                <div class="trades-table-container">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Data/Ora</th>
                                <th>Tipo</th>
                                <th>Simbolo</th>
                                <th>Quantità</th>
                                <th>Prezzo</th>
                                <th>P&L</th>
                                <th>Strategia</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTableBody">
                            <!-- Trade history will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        // URL del tuo backend su Render
        const BACKEND_URL = window.location.origin;
        let performanceChart = null;
        let currentUser = null;
        let token = null;
        let botActive = false;
        let selectedMode = 'paper';
        let selectedStrategy = 'sma_crossover';
        let symbols = [];
        
        let stats = {
            totalTrades: 0,
            wins: 0,
            losses: 0,
            totalPL: 0,
            dailyPL: 0,
            monthlyPL: 0
        };

        // Login handling
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Inserisci email e password');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    currentUser = jwtDecode(token);
                    showDashboard();
                    addLog('✅ Accesso effettuato con successo', 'success');
                    loadUserConfiguration();
                    loadTradeHistory();
                    initPerformanceChart();
                } else {
                    addLog(`❌ Errore accesso: ${data.error}`, 'error');
                    alert(data.error || 'Errore durante il login');
                }
            } catch (error) {
                addLog(`❌ Errore di connessione: ${error.message}`, 'error');
                alert('Errore di connessione al server');
            }
        }
        
        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert('Inserisci email e password');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    token = data.token;
                    currentUser = jwtDecode(token);
                    showDashboard();
                    addLog('✅ Registrazione completata con successo', 'success');
                    initPerformanceChart();
                } else {
                    addLog(`❌ Errore registrazione: ${data.error}`, 'error');
                    alert(data.error || 'Errore durante la registrazione');
                }
            } catch (error) {
                addLog(`❌ Errore di connessione: ${error.message}`, 'error');
                alert('Errore di connessione al server');
            }
        }
        
        function jwtDecode(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        // Mode selection
        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`.mode-${mode}`).classList.add('selected');
            
            if (mode === 'live') {
                addLog('⚠️ ATTENZIONE: Modalità trading reale selezionata!', 'warning');
            } else {
                addLog('✅ Modalità paper trading selezionata', 'success');
            }
        }
        
        // Strategy selection  
        function selectStrategy(strategy) {
            selectedStrategy = strategy;
            document.querySelectorAll('.strategy-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.strategy-card').classList.add('selected');
            addLog(`📊 Strategia selezionata: ${strategy}`, 'info');
        }
        
        // Symbol management
        function addSymbol() {
            const input = document.getElementById('newSymbol');
            const symbol = input.value.toUpperCase().trim();
            
            if (symbol && !symbols.includes(symbol)) {
                symbols.push(symbol);
                updateSymbolsDisplay();
                input.value = '';
                addLog(`➕ Simbolo aggiunto: ${symbol}`, 'info');
            }
        }
        
        function addSymbolOnEnter(event) {
            if (event.key === 'Enter') {
                addSymbol();
            }
        }
        
        function removeSymbol(symbol) {
            symbols = symbols.filter(s => s !== symbol);
            updateSymbolsDisplay();
            addLog(`➖ Simbolo rimosso: ${symbol}`, 'info');
        }
        
        function updateSymbolsDisplay() {
            const container = document.getElementById('symbolsList');
            container.innerHTML = symbols.map(symbol => 
                `<div class="symbol-tag">${symbol} <span class="remove" onclick="removeSymbol('${symbol}')">✕</span></div>`
            ).join('');
        }
        
        // Bot control
        function toggleBot() {
            if (!validateConfiguration()) return;
            
            if (botActive) {
                stopBot();
            } else {
                startBot();
            }
        }
        
        async function startBot() {
            const config = {
                mode: selectedMode,
                strategy: selectedStrategy,
                symbols: symbols,
                tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
                stopLoss: parseFloat(document.getElementById('stopLoss').value),
                takeProfit: parseFloat(document.getElementById('takeProfit').value),
                maxTrades: parseInt(document.getElementById('maxTrades').value),
                apiKey: document.getElementById('apiKey').value,
                secretKey: document.getElementById('secretKey').value,
                telegramToken: document.getElementById('telegramToken').value,
                chatId: document.getElementById('chatId').value
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/start-bot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        config: config
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    botActive = true;
                    document.getElementById('startBtn').textContent = '⏹️ FERMA BOT';
                    document.getElementById('startBtn').className = 'btn btn-stop';
                    document.getElementById('botStatus').textContent = 'ATTIVO';
                    document.getElementById('botStatus').style.color = '#27ae60';
                    
                    addLog(`🚀 Bot avviato in modalità ${selectedMode.toUpperCase()}`, 'success');
                    addLog(`📊 Strategia: ${selectedStrategy}`, 'info');
                    addLog(`🎯 Simboli: ${symbols.join(', ')}`, 'info');
                    
                    // Inizia a controllare lo stato periodicamente
                    checkBotStatus();
                } else {
                    addLog(`❌ Errore: ${data.error || 'Impossibile avviare il bot'}`, 'error');
                }
            } catch (error) {
                addLog(`❌ Errore di connessione: ${error.message}`, 'error');
            }
        }
        
        async function stopBot() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/stop-bot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    botActive = false;
                    document.getElementById('startBtn').textContent = '🚀 AVVIA BOT';
                    document.getElementById('startBtn').className = 'btn btn-start';
                    document.getElementById('botStatus').textContent = 'FERMO';
                    document.getElementById('botStatus').style.color = '#e67e22';
                    
                    addLog('⏹️ Bot fermato', 'warning');
                }
            } catch (error) {
                addLog(`❌ Errore: ${error.message}`, 'error');
            }
        }
        
        async function checkBotStatus() {
            if (!botActive) return;
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/bot-status/${currentUser.userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const status = await response.json();
                
                // Aggiorna le statistiche
                stats.totalTrades = status.totalTrades || 0;
                stats.wins = status.wins || 0;
                stats.losses = status.losses || 0;
                stats.totalPL = status.totalPL || 0;
                stats.dailyPL = status.dailyPL || 0;
                stats.monthlyPL = status.monthlyPL || 0;
                
                updateStatsDisplay();
                
                // Aggiorna il grafico delle performance
                updatePerformanceChart();
                
                // Aggiorna la tabella degli ultimi trade
                if (status.tradeHistory) {
                    updateTradeHistoryTable(status.tradeHistory);
                }
                
                // Controlla di nuovo dopo 5 secondi
                setTimeout(checkBotStatus, 5000);
            } catch (error) {
                addLog(`⚠️ Impossibile ottenere lo stato: ${error.message}`, 'warning');
                setTimeout(checkBotStatus, 10000);
            }
        }
        
        function emergencyStop() {
            if (confirm('Sei sicuro di voler eseguire uno STOP di emergenza?')) {
                stopBot();
                addLog('🚨 STOP DI EMERGENZA ESEGUITO!', 'error');
            }
        }
        
        function validateConfiguration() {
            const apiKey = document.getElementById('apiKey').value;
            const secretKey = document.getElementById('secretKey').value;
            
            if (!apiKey || !secretKey) {
                alert('Inserisci le credenziali Alpaca API!');
                return false;
            }
            
            if (symbols.length === 0) {
                alert('Seleziona almeno un simbolo da tradare!');
                return false;
            }
            
            return true;
        }
        
        // Configuration management
        async function saveConfiguration() {
            const config = {
                mode: selectedMode,
                strategy: selectedStrategy,
                symbols: symbols,
                tradeAmount: document.getElementById('tradeAmount').value,
                stopLoss: document.getElementById('stopLoss').value,
                takeProfit: document.getElementById('takeProfit').value,
                maxTrades: document.getElementById('maxTrades').value,
                apiKey: document.getElementById('apiKey').value,
                secretKey: document.getElementById('secretKey').value,
                telegramToken: document.getElementById('telegramToken').value,
                chatId: document.getElementById('chatId').value
            };
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/user-config`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog('💾 Configurazione salvata', 'success');
                } else {
                    addLog('❌ Errore durante il salvataggio della configurazione', 'error');
                }
            } catch (error) {
                addLog(`❌ Errore di connessione: ${error.message}`, 'error');
            }
        }
        
        async function loadUserConfiguration() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/user-config`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    
                    // Load saved values
                    document.getElementById('tradeAmount').value = config.tradeAmount || 100;
                    document.getElementById('stopLoss').value = config.stopLoss || 2;
                    document.getElementById('takeProfit').value = config.takeProfit || 4;
                    document.getElementById('maxTrades').value = config.maxTrades || 10;
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('secretKey').value = config.secretKey || '';
                    document.getElementById('telegramToken').value = config.telegramToken || '';
                    document.getElementById('chatId').value = config.chatId || '';
                    
                    if (config.symbols) {
                        symbols = config.symbols;
                        updateSymbolsDisplay();
                    }
                    
                    selectMode(config.mode || 'paper');
                    selectedStrategy = config.strategy || 'sma_crossover';
                    
                    // Seleziona la strategia nell'interfaccia
                    document.querySelectorAll('.strategy-card').forEach(card => card.classList.remove('selected'));
                    const strategyCard = Array.from(document.querySelectorAll('.strategy-card')).find(card => 
                        card.querySelector('h4').textContent.includes(config.strategy.replace('_', ' ')) ||
                        card.querySelector('h4').textContent.includes('SMA Crossover');
                    if (strategyCard) strategyCard.classList.add('selected');
                    
                    addLog('📋 Configurazione caricata', 'info');
                }
            } catch (error) {
                addLog(`❌ Errore durante il caricamento della configurazione: ${error.message}`, 'error');
            }
        }
        
        async function loadTradeHistory() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/trade-history`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    // Prendi l'ultimo storico
                    const latestHistory = data.history[0].trades || [];
                    updateTradeHistoryTable(latestHistory);
                }
            } catch (error) {
                console.error('Errore caricamento storico:', error);
            }
        }
        
        function updateTradeHistoryTable(trades) {
            const tableBody = document.getElementById('tradesTableBody');
            tableBody.innerHTML = '';
            
            // Ordina i trade dal più recente al più vecchio
            const sortedTrades = [...trades].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedTrades.forEach(trade => {
                const row = document.createElement('tr');
                const date = new Date(trade.timestamp).toLocaleString();
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${trade.type === 'buy' ? 'Acquisto' : 'Vendita'}</td>
                    <td>${trade.symbol}</td>
                    <td>${trade.quantity || ''}</td>
                    <td>$${trade.price?.toFixed(2) || trade.entryPrice?.toFixed(2) || ''}</td>
                    <td class="${trade.pl > 0 ? 'profit-cell' : trade.pl < 0 ? 'loss-cell' : ''}">
                        ${trade.pl !== undefined ? `$${trade.pl.toFixed(2)}` : ''}
                    </td>
                    <td>${trade.strategy || ''}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Telegram testing
        function testTelegram() {
            const token = document.getElementById('telegramToken').value;
            const chatId = document.getElementById('chatId').value;
            
            if (!token || !chatId) {
                alert('Inserisci Token e Chat ID Telegram!');
                return;
            }
            
            addLog('📱 Test Telegram in corso...', 'info');
            
            // Simulate telegram test
            setTimeout(() => {
                addLog('✅ Test Telegram completato con successo!', 'success');
            }, 2000);
        }
        
        // Performance chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug'],
                    datasets: [{
                        label: 'Performance',
                        data: [0, 100, 150, 200, 250, 300, 350],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }
        
        function updatePerformanceChart() {
            if (!performanceChart) return;
            
            // Simula dati aggiornati (nella versione reale dovresti usare i dati effettivi)
            const newData = performanceChart.data.datasets[0].data.map(value => value + (Math.random() * 50 - 25));
            performanceChart.data.datasets[0].data = newData;
            performanceChart.update();
        }
        
        // Statistics display
        function updateStatsDisplay() {
            document.getElementById('totalTrades').textContent = stats.totalTrades;
            document.getElementById('winRate').textContent = stats.totalTrades > 0 ? 
                `${((stats.wins / stats.totalTrades) * 100).toFixed(1)}%` : '0%';
            
            const totalPLElement = document.getElementById('totalPL');
            totalPLElement.textContent = `$${stats.totalPL.toFixed(2)}`;
            totalPLElement.className = `status-value ${stats.totalPL >= 0 ? 'profit' : 'loss'}`;
            
            const dailyPLElement = document.getElementById('dailyPL');
            dailyPLElement.textContent = `$${stats.dailyPL.toFixed(2)}`;
            dailyPLElement.className = `status-value ${stats.dailyPL >= 0 ? 'profit' : 'loss'}`;
            
            const monthlyPLElement = document.getElementById('monthlyPL');
            monthlyPLElement.textContent = `$${stats.monthlyPL.toFixed(2)}`;
            monthlyPLElement.className = `status-value ${stats.monthlyPL >= 0 ? 'profit' : 'loss'}`;
        }
        
        // Logging system
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const emojis = {
                'info': '🔵',
                'success': '✅', 
                'warning': '⚠️',
                'error': '❌'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span>[${timestamp}] ${message}</span>
                <span>${emojis[type] || '🔵'}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 50 entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // Auto-save configuration on changes
        document.addEventListener('input', function(e) {
            if (currentUser && e.target.matches('input, select')) {
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(saveConfiguration, 2000);
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            selectMode('paper'); // Default to paper trading
            addLog('🚀 TradingBot Pro inizializzato', 'success');
            addLog('📋 Configura le tue credenziali API per iniziare', 'info');
        });
        
        // Prevent accidental page reload when bot is active
        window.addEventListener('beforeunload', function(e) {
            if (botActive) {
                e.preventDefault();
                e.returnValue = 'Il bot è attivo. Sei sicuro di voler chiudere?';
            }
        });
    </script>
</body>
</html>